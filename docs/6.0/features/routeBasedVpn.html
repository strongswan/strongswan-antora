<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Route-based VPN :: strongSwan Documentation</title>
    <link rel="canonical" href="https://docs.strongswan.org/docs/5.9/features/routeBasedVpn.html">
    <link rel="prev" href="networkManager.html">
    <link rel="next" href="highAvailability.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="../../../_/css/site-extra.css">
    <meta name="google-site-verification" content="pFYsGHXifqmasGBdCNNgzV4OxVDn2d3Zm0DK9WUYCl0" />
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.strongswan.org">strongSwan Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://strongswan.org">strongswan.org</a>
        <a class="navbar-item" href="https://download.strongswan.org">Downloads</a>
        <a class="navbar-item" href="https://github.com/strongswan">GitHub</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs" data-version="6.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">strongSwan Docs</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">News</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../news/whatsNew.html">What&#8217;s New in strongSwan 6.0</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Installation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../install/install.html">Installation Documentation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../install/autoconf.html">Autoconf Options</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../install/kernelModules.html">Required Kernel Modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../install/reducedPrivileges.html">Reduced Privileges</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../install/trafficDumps.html">Taking Traffic Dumps</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Configuration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../config/config.html">Configuration Files</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../config/strongswanConf.html">strongswan.conf</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../config/strongswanDir.html">strongswan.d Directory</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlConf.html">swanctl.conf</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlDir.html">swanctl Directory</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/IKEv2CipherSuites.html">IKEv2 Cipher Suites</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/identityParsing.html">Identity Parsing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/jobPriority.html">Job Priority Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/lookupTuning.html">Tuning IKE SA Lookup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/rekeying.html">IKE and IPsec SA Renewal</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/retransmission.html">Retransmission</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/tlsOptions.html">TLS Options</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/sqliteDbSchema.html">SQLite Database Schema</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/IPv6Ndp.html">IPv6 and the Neighbor Discovery Protocol</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Features</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="vip.html">Virtual IP Addresses</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="mobike.html">MOBIKE</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="natTraversal.html">NAT Traversal</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ipcomp.html">IPComp</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="networkManager.html">NetworkManager</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="routeBasedVpn.html">Route-based VPN</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="highAvailability.html">High Availability</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="hashAndUrl.html">Hash and URL</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="integrityTests.html">Integrity Tests</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ietf.html">IPsec and Related Standards</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Howtos</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/quickstart.html">Configuration Quickstart</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../pki/pkiQuickstart.html">Certificates Quickstart</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../pki/caManagement.html">GUI-based CA Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../howtos/introduction.html">Introduction to strongSwan</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../howtos/ipsecProtocol.html">IPsec Protocol</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../howtos/forwarding.html">Forwarding and Split-Tunneling</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../howtos/securityRecommendations.html">Security Recommendations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../howtos/smartcards.html">Smart Card Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../howtos/cloudPlatforms.html">Cloud Platforms</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../howtos/nameSpaces.html">strongSwan in Linux Network Namespaces</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Daemons</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../daemons/charon.html">charon</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../daemons/charon-systemd.html">charon-systemd</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../daemons/charon-svc.html">charon-svc</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../daemons/charon-cmd.html">charon-cmd</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">OS</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../os/android.html">Android</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../os/androidVpnClient.html">Android VPN Client</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../os/androidVpnClientProfiles.html">Android VPN Client Profiles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../os/androidVpnClientPrivacyPolicy.html">Android VPN Privacy Policy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../os/androidVpnClientBuild.html">Android VPN Client Build</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../os/windows.html">Windows</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../os/freebsd.html">FreeBSD</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../os/macos.html">macOS</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Interoperability</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../interop/windowsClients.html">Windows Clients</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../interop/windowsCertRequirements.html">Windows Certificate Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../interop/windowsClients.html#_using_x_509_machine_certificates">Using Machine Certificates</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsMachineCert.html">Storing a Windows Machine Certificate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsMachineConf.html">Windows Client Configuration with Machine Certificates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsMachineConnect.html">Windows Client Connection with Machine Certificates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsMachineServerConf.html">strongSwan Configuration for Windows Machine Certificates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsMachineServerStatus.html">strongSwan Connection Status with Windows Machine Certificates</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../interop/windowsClients.html#_using_x_509_user_certificates">Using User Certificates</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsUserCert.html">Storing a Windows User Certificate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsCaCert.html">Storing a Windows CA Certificate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsUserConf.html">Windows Client Configuration with User Certificates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsUserConnect.html">Windows Client Connection with User Certificates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsUserServerConf.html">strongSwan Configuration for Windows User Certificates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsUserServerStatus.html">strongSwan Connection Status with Windows User Certificates</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../interop/windowsClients.html#_using_passwords_with_eap_mschapv2">Using EAP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsEapConf.html">Windows Client EAP Configuration with Passwords</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsEapConnect.html">Windows Client EAP Connection with Passwords</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsEapServerConf.html">strongSwan EAP Configuration with Passwords</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../interop/windowsEapServerStatus.html">strongSwan EAP Connection Status with Passwords</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../interop/microsoftStatusNotify.html">Microsoft Status Notify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../interop/ios.html">iOS and macOS</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../interop/appleIkev2Profile.html">Apple IKEv2 Configuration Profile</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../interop/fortinet.html">Fortinet Devices</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Tools</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../swanctl/swanctl.html">swanctl Tool</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlCounters.html">swanctl --counters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlFlushCerts.html">swanctl --flush-certs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlInitiate.html">swanctl --initiate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlInstall.html">swanctl --install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlListAlgs.html">swanctl --list-algs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlListAuths.html">swanctl --list-authorities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlListCerts.html">swanctl --list-certs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlListConns.html">swanctl --list-conns</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlListPols.html">swanctl --list-pols</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlListPools.html">swanctl --list-pools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlListSas.html">swanctl --list-sas</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlLoadAll.html">swanctl --load-all</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlLoadAuths.html">swanctl --load-authorities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlLoadConns.html">swanctl --load-conns</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlLoadCreds.html">swanctl --load-creds</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlLoadPools.html">swanctl --load-pools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlLog.html">swanctl --log</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlRedirect.html">swanctl --redirect</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlRekey.html">swanctl --rekey</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlReloadSettings.html">swanctl --reload-settings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlStats.html">swanctl --stats</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlTerminate.html">swanctl --terminate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlUninstall.html">swanctl --uninstall</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../swanctl/swanctlVersion.html">swanctl --version</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../pki/pki.html">pki Tool</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiAcert.html">pki --acert</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiDn.html">pki --dn</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiEst.html">pki --est</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiEstCa.html">pki --estca</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiGen.html">pki --gen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiIssue.html">pki --issue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiKeyid.html">pki --keyid</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiPkcs12.html">pki --pkcs12</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiPkcs7.html">pki --pkcs7</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiPrint.html">pki --print</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiPub.html">pki --pub</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiReq.html">pki --req</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiScep.html">pki --scep</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiScepCa.html">pki --scepca</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiSelf.html">pki --self</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiSignCrl.html">pki --signcrl</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pki/pkiVerify.html">pki --verify</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../tnc/pt-tls-client.html">pt-tls-client Tool</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../tnc/sw-collector.html">sw-collector Tool</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../tnc/sec-updater.html">sec-updater Tool</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../tools/pool.html">ipsec pool Tool</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../tnc/attest.html">ipsec attest Tool</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../tools/conftest.html">ipsec conftest Tool</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../tools/scepclient.html">ipsec scepclient Tool</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Plugins</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../plugins/plugins.html">Plugin List</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/addrblock.html">addrblock Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/attr.html">attr Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/attr-sql.html">attr-sql Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/bypass-lan.html">bypass-lan Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/certexpire.html">certexpire Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/connmark.html">connmark Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/constraints.html">constraints Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/counters.html">counters Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/coupling.html">coupling Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/curl.html">curl Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/dhcp.html">dhcp Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/duplicheck.html">duplicheck Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/eap-dynamic.html">eap-dynamic Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/eap-gtc.html">eap-gtc Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/eap-radius.html">eap-radius Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/eap-simaka-sql.html">eap-simaka-sql Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/eap-tls.html">eap-tls Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/error-notify.html">error-notify Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/ext-auth.html">ext-auth Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/farp.html">farp Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/forecast.html">forecast Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/ha.html">ha Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/kernel-iph.html">kernel-iph Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/kernel-libipsec.html">kernel-libipsec Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/kernel-wfp.html">kernel-wfp Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/load-tester.html">load-tester Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/lookip.html">lookip Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/pkcs11.html">pkcs11 Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/radattr.html">radattr Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/resolve.html">resolve Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/save-keys.html">save-keys Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/selinux.html">selinux Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/socket-win.html">socket-win Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/sql.html">sql Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/systime-fix.html">systime-fix Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/test-vectors.html">test-vectors Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/tnc-ifmap.html">tnc-ifmap Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/tpm.html">tpm Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/unity.html">unity Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/updown.html">updown Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/vici.html">vici Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/whitelist.html">whitelist Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/winhttp.html">winhttp Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/xauth-eap.html">xauth-eap Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/xauth-noauth.html">xauth-noauth Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/xauth-pam.html">xauth-pam Plugin</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../plugins/pluginLoad.html">Plugin Load Options</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Development</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../devs/devs.html">Developer Documentation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../devs/contributions.html">Contributions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../devs/programmingStyle.html">Programming Style</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../devs/objectOrientedC.html">Object Oriented C</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../devs/testingEnvironment.html">Testing Environment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../devs/fuzzing.html">Fuzzing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Platform Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../tpm/tpm2.html">TPM 2.0</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tpm/tpm2Ike.html">TPM 2.0 Use with strongSwan IKE Daemon</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../tnc/tnc.html">Trusted Network Connect</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tnc/tncClient.html">TNC Client</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tnc/tncServer.html">TNC Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tnc/optimumTncSizes.html">Optimum PB-TNC Batch and PA-TNC Message Sizes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tnc/strongTnc.html">strongTNC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../tnc/swima.html">Software Inventory</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tnc/swimaClient.html">Software Inventory Client</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tnc/swimaServer.html">Software Inventory Server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../tnc/measuredBoot.html">Measured Boot</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tnc/attestationClient.html">Attestation Client</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tnc/attestationServer.html">Attestation Server</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tnc/pcrBootEvents.html">PCR Boot Events</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../tnc/ima.html">Integrity Measurement Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tnc/imaClient.html">IMA Client</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tnc/imaServer.html">IMA Server</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Support</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../support/helpRequests.html">Help Requests</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../support/faq.html">FAQ</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../support/flawReporting.html">Flaw Reporting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../support/free.html">Free Support</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../support/commercial.html">Commercial Support</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Publications</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../publications/publications.html">Publications and Presentations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="https://strongswan.org/blog">strongSwan Blog</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">strongSwan Docs</span>
    <span class="version">6.0 Beta</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../../5.9/index.html">strongSwan Docs</a>
      <ul class="versions">
        <li class="version is-current">
          <a href="../index.html">6.0 Beta</a>
        </li>
        <li class="version is-latest">
          <a href="../../5.9/index.html">5.9</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../5.9/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">strongSwan Docs</a></li>
    <li>Features</li>
    <li><a href="routeBasedVpn.html">Route-based VPN</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">6.0 Beta</button>
  <div class="version-menu">
    <a class="version is-current" href="routeBasedVpn.html">6.0 Beta</a>
    <a class="version" href="../../5.9/features/routeBasedVpn.html">5.9</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/strongswan/strongswan-docs/edit/docs-6.0/docs/modules/ROOT/pages/features/routeBasedVpn.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Route-based VPN</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Generally IPsec processing is based on policies. After regular route lookups are
done the OS kernel consults its SPD (Security Policy Database) for a matching
policy and if one is found that is associated with an IPsec SA (Security
Association) the packet is processed (e.g. encrypted and sent as ESP packet).</p>
</div>
<div class="paragraph">
<p>Depending on the operating system it is also possible to configure route-based
VPNs. Here IPsec processing does not (only) depend on negotiated policies but may
e.g. be controlled by routing packets to a specific interface.</p>
</div>
<div class="paragraph">
<p>Most of these approaches also allow an easy capture of plaintext traffic, which
depending on the operating system might not be that straight-forward with
policy-based VPNs, see <a href="../install/trafficDumps.html" class="xref page">Traffic Dumps</a>.
Another advantage this approach could have is that the MTU can be specified for
the tunneling devices, allowing to fragment packets before tunneling them, in case
PMTU discovery does not work properly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vti_devices_on_linux"><a class="anchor" href="#_vti_devices_on_linux"></a>VTI Devices on Linux</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
VTI devices are supported since the Linux 3.6 kernel but some important
      changes were added later (3.15+). The information below might not be accurate
      for older kernel versions. On newer kernels (4.19+), XFRM interfaces provide
      a better solution than VTI devices, see <a href="#_xfrm_interfaces_on_linux">below</a>
      for details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>VTI devices act like a wrapper around existing IPsec policies. This means you can&#8217;t
just route arbitrary packets to a VTI device to get them tunneled, the established
IPsec policies have to match, too. However, you can negotiate <code><strong>0.0.0.0/0</strong></code> traffic
selectors on both ends to allow tunneling any traffic that is routed via the VTI
device.</p>
</div>
<div class="paragraph">
<p>To make this work, i.e. to prevent packets not routed via the VTI device from matching
the policies (if <code><strong>0.0.0.0/0</strong></code> is used every packet would match), <strong>marks</strong> are used.
Only packets that are marked accordingly will match the policies and get tunneled.
For other packets the policies are ignored. Whenever a packet is routed to a VTI
device it automatically gets the configured mark applied, so it will match the
policy and get tunneled.</p>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that VTI tunnel devices are a local feature, no additional
encapsulation (like with GRE, see <a href="#_gre_tunnels">below</a>) is added, so the other
end does not have to be aware that VTI devices are used in addition to regular IPsec
policies.</p>
</div>
<div class="sect2">
<h3 id="_vti_device_management"><a class="anchor" href="#_vti_device_management"></a>VTI Device Management</h3>
<div class="paragraph">
<p>A VTI device may be created with the following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip tunnel add &lt;name&gt; local &lt;local IP&gt; remote &lt;remote IP&gt; mode vti key &lt;mark&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><code>&lt;name&gt;</code> can be any valid device name (e.g. <code><strong>ipsec0</strong></code>, <code><strong>vti0</strong></code> etc.). But note
that the <code><strong>ip</strong></code> command treats names starting with <code><strong>vti</strong></code> special in some instances
(e.g. when retrieving device statistics). The IP addresses are the endpoints of the
IPsec tunnel. <code>&lt;mark&gt;</code> has to match the mark configured for the connection. It is
also possible to configure different marks for in- and outbound traffic using
<code><strong>ikey</strong> &lt;mark&gt;</code> and <code><strong>okey</strong> &lt;mark&gt;</code>, but that is usually not required.</p>
</div>
<div class="paragraph">
<p>After creating the device, it has to be enabled (<code><strong>ip link set</strong> &lt;name&gt; <strong>up</strong></code>) and
then routes may be installed (routing protocols may also be used).  To avoid
duplicate policy lookups it is also recommended to set</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sysctl -w net.ipv4.conf.&lt;name&gt;.disable_policy=1</pre>
</div>
</div>
<div class="paragraph">
<p>All of this also works for IPv6.</p>
</div>
<div class="sect3">
<h4 id="_example_creation_of_two_vti_devices_vti0_and_ipsec0"><a class="anchor" href="#_example_creation_of_two_vti_devices_vti0_and_ipsec0"></a>Example: Creation of two VTI Devices (vti0 and ipsec0)</h4>
<div class="listingblock">
<div class="content">
<pre>ip tunnel add vti0   local 192.168.0.1 remote 192.168.0.2 mode vti key 42
ip tunnel add ipsec0 local 192.168.0.1 remote 192.168.0.2 mode vti key 0x01000201
sysctl -w net.ipv4.conf.vti0.disable_policy=1
ip link set vti0 up
ip route add 10.1.0.0/16 dev vti0
sysctl -w net.ipv4.conf.ipsec0.disable_policy=1
ip link set ipsec0 up
ip route add 10.2.0.0/16 dev ipsec0
ip route add 10.3.0.0/16 dev ipsec0</pre>
</div>
</div>
<div class="paragraph">
<p>Statistics on VTI devices may be displayed with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip -s tunnel show [&lt;name&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>Note that specifying a name will not show any statistics if the device name starts
with <code><strong>vti</strong></code>.</p>
</div>
<div class="paragraph">
<p>A VTI device may be removed again with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip tunnel del &lt;name&gt;</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h3>
<div class="paragraph">
<p>First the route installation by the IKE daemon must be disabled. To do this, set
in <a href="../config/strongswanConf.html" class="xref page"><code><strong>strongswan.conf</strong></code></a>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>charon.install_routes = 0</pre>
</div>
</div>
<div class="paragraph">
<p>Then configure a regular site-to-site connection, either with the traffic selectors
set to <code><strong>0.0.0.0/0</strong></code> on both ends</p>
</div>
<div class="listingblock">
<div class="content">
<pre>local_ts  = 0.0.0.0/0
remote_ts = 0.0.0.0/0</pre>
</div>
</div>
<div class="paragraph">
<p>in <a href="../swanctl/swanctlConf.html" class="xref page"><code><strong>swanctl.conf</strong></code></a> or set to specific subnets. As
mentioned above, only traffic that matches these traffic selectors will then
actually be forwarded. Other packets routed to the VTI device will be rejected with
an ICMP error message (<code>destination unreachable/destination host unreachable</code>).</p>
</div>
<div class="paragraph">
<p>The most important configuration optiona are <code><strong>mark_in</strong></code> and <code><strong>mark_out</strong></code> in
<a href="../swanctl/swanctlConf.html" class="xref page"><code><strong>swanctl.conf</strong></code></a>. After applying the optional mask
(default is <code><strong>0xffffffff</strong></code>) to the mark that&#8217;s set on the VTI device and it applied
to the routed packets, the value has to match the configured mark.</p>
</div>
<div class="paragraph">
<p>Referring to the example above, to match the mark on <code><strong>vti0</strong></code>, configure
<code><strong>mark_in</code></strong> = <code><strong>mark_out</strong></code> = <code><strong>42</strong></code> and to match the mark on <code><strong>ipsec0</strong></code>, set the
value to <code><strong>0x01000201</strong></code> (but something like <code><strong>0x00000200/0x00000f00</strong></code> would also
work).</p>
</div>
</div>
<div class="sect2">
<h3 id="_example"><a class="anchor" href="#_example"></a>Example</h3>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.strongswan.org/testing/testresults6/route-based/net2net-vti"><img src="../_images/a-m-w-s-b.png" alt="topology" width="501" height="190"></a>
</div>
<div class="title">Figure 1. strongSwan <a href="https://www.strongswan.org/testing/testresults6/route-based/net2net-vti">example</a> showing the use of VTI devices</div>
</div>
</div>
<div class="sect2">
<h3 id="_sharing_vti_devices"><a class="anchor" href="#_sharing_vti_devices"></a>Sharing VTI Devices</h3>
<div class="paragraph">
<p>VTI devices may be shared by multiple IPsec SAs (e.g. in roadwarrior scenarios,
to capture traffic or lower the MTU) by setting the remote endpoint of the VTI
device to <code><strong>0.0.0.0</code></strong>. For instance:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip tunnel add ipsec0 local 192.168.0.1 remote 0.0.0.0 mode vti key 42</pre>
</div>
</div>
<div class="paragraph">
<p>Then assuming <a href="vip.html" class="xref page">virtual IP</a> addresses for roadwarriors are
assigned from the <code><strong>10.0.1.0/24</strong></code> subnet a matching route may be installed with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip route add 10.0.1.0/24 dev ipsec0</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only one such device with the same local IP may be created.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_example_2"><a class="anchor" href="#_example_2"></a>Example</h3>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.strongswan.org/testing/testresults6/route-based/rw-shared-vti"><img src="../_images/a-m-c-w-d.png" alt="topology" width="372" height="190"></a>
</div>
<div class="title">Figure 2. strongSwan <a href="https://www.strongswan.org/testing/testresults6/route-based/rw-shared-vti">example</a> showing the use of shared VTI devices</div>
</div>
</div>
<div class="sect2">
<h3 id="_connection_specific_vti_devices"><a class="anchor" href="#_connection_specific_vti_devices"></a>Connection-specific VTI Devices</h3>
<div class="paragraph">
<p>With a custom <a href="../plugins/updown.html" class="xref page"><code><strong>updown</strong></code></a> script it is also possible to
set up connection-specific VTI devices. For instance, to create a VTI device on a
roadwarrrior client that receives a dynamic <a href="vip.html" class="xref page">virtual IP</a>
address (courtesy of Endre Szab√≥):</p>
</div>
<div class="sect3">
<h4 id="_example_script_for_roadwarriors"><a class="anchor" href="#_example_script_for_roadwarriors"></a>Example Script for Roadwarriors</h4>
<div class="listingblock">
<div class="content">
<pre>#!/bin/bash

# set charon.install_virtual_ip = no to prevent the daemon from also installing the VIP

set -o nounset
set -o errexit

VTI_IF="vti${PLUTO_UNIQUEID}"

case "${PLUTO_VERB}" in
    up-client)
        ip tunnel add "${VTI_IF}" local "${PLUTO_ME}" remote "${PLUTO_PEER}" mode vti \
            key "${PLUTO_MARK_OUT%%/*}"
        ip link set "${VTI_IF}" up
        ip addr add "${PLUTO_MY_SOURCEIP}" dev "${VTI_IF}"
        ip route add "${PLUTO_PEER_CLIENT}" dev "${VTI_IF}"
        sysctl -w "net.ipv4.conf.${VTI_IF}.disable_policy=1"
        ;;
    down-client)
        ip tunnel del "${VTI_IF}"
        ;;
esac</pre>
</div>
</div>
<div class="paragraph">
<p>If there is more than one subnet in the remote traffic selector this might cause
conflicts as the <a href="../plugins/updown.html" class="xref page"><code><strong>updown</strong></code></a> script will be called for
each combination of local and remote subnet.</p>
</div>
<div class="paragraph">
<p>Dynamically creating such devices on the server could be problematic if two
roadwarriors are connected from the same IP. The kernel rejects the creation of
a VTI device if the remote and local addresses are already in use by another VTI
device.</p>
</div>
<div class="paragraph">
<p>In the following script, it is assumed that only the roadwarrior&#8217;s assigned IPv4
IP is supposed to be reachable over the assigned tunnel.</p>
</div>
</div>
<div class="sect3">
<h4 id="_example_script_for_gateways"><a class="anchor" href="#_example_script_for_gateways"></a>Example Script for Gateways</h4>
<div class="listingblock">
<div class="content">
<pre>#!/bin/bash

# set charon.install_virtual_ip = no to prevent the daemon from also installing the VIP

set -o nounset
set -o errexit

VTI_IF="vti${PLUTO_UNIQUEID}"

case "${PLUTO_VERB}" in
    up-client)
        ip tunnel add "${VTI_IF}" local "${PLUTO_ME}" remote "${PLUTO_PEER}" mode vti \
            key "${PLUTO_MARK_OUT%%/*}"
        ip link set "${VTI_IF}" up
        ip route add "${PLUTO_PEER_SOURCEIP}" dev "${VTI_IF}"
        sysctl -w "net.ipv4.conf.${VTI_IF}.disable_policy=1"
        ;;
    down-client)
        ip tunnel del "${VTI_IF}"
        ;;
esac</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using <strong>PLUTO_UNIQUEID</strong> might not be a good idea if IKE_SAs may be rekeyed,
      as the unique ID will change with each rekeying (i.e. the script won&#8217;t be
      able to delete the device anymore). Using some other identifier (e.g. parts
      of the virtual IP or the mark if it is unique) might be better.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_xfrm_interfaces_on_linux"><a class="anchor" href="#_xfrm_interfaces_on_linux"></a>XFRM Interfaces on Linux</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
strongSwan supports XFRM interfaces since version 5.8.0. They are supported
      by the Linux kernel since 4.19 and <strong>iproute2</strong> version 5.1.0+.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>XFRM interfaces are similar to VTI devices in their basic functionality (see
<a href="#_vti_devices_on_linux">above</a> for details) but offer several advantages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No tunnel endpoint addresses have to be configured on the interfaces. Compared
to VTIs, which are layer 3 tunnel devices with mandatory endpoints, this resolves
issues with wildcard addresses (only one VTI with wildcard endpoints is supported),
avoids a 1:1 mapping between SAs and interfaces and easily allows SAs with multiple
peers to share the same interface.</p>
</li>
<li>
<p>Because there are no endpoint addresses, IPv4 and IPv6 SAs are supported on the
same interface (VTI devices only support one address family).</p>
</li>
<li>
<p>IPsec modes other than tunnel are supported (VTI devices only support tunnel
mode).</p>
</li>
<li>
<p>No awkward configuration via GRE keys and XFRM marks. Instead, a new identifier
(XFRM interface ID) links policies and SAs with XFRM interfaces.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As mentioned above, the policies and SAs are linked to XFRM interface via a new
identifier (interface ID). Like XFRM marks they are part of the policy selector.
That is, policies will only match traffic if it was routed via an XFRM interface
with a matching interface ID and duplicate policies are allowed as long as the
interface ID is different. So as with VTI devices it&#8217;s possible to negotiate
<code><strong>0.0.0.0/0</strong></code> as traffic selector on both ends (to tunnel arbitrary traffic) for
multiple CHILD_SAs as long as the interface IDs are different.</p>
</div>
<div class="paragraph">
<p>Traffic that&#8217;s routed to an XFRM interface, while no policies and SAs with matching
interface ID exist, will be dropped by the kernel. Likewise, as long as no interface
with a matching interface ID exists, the policies and SAs will not be operational
(i.e. outbound traffic bypasses the policies and inbound traffic is dropped). So
it&#8217;s possible to create interfaces before SAs are created or afterwards (e.g. via
<a href="../plugins/vici.html" class="xref page"><code><strong>vici</strong></code></a> events or <a href="../plugins/updown.html" class="xref page"><code><strong>updown</strong></code></a>
scripts which both receive configured or optionally dynamically generated interface
IDs).</p>
</div>
<div class="paragraph">
<p>Using trap policies to dynamically create IPsec SAs based on matching traffic that
has been routed to an XFRM interface is also an option.</p>
</div>
<div class="paragraph">
<p>It&#8217;s possible to use separate interfaces for in- and outbound traffic, which is
why interface IDs may be configured for in- and outbound policies/SAs separately
(see below).</p>
</div>
<div class="sect2">
<h3 id="_xfrm_interface_management"><a class="anchor" href="#_xfrm_interface_management"></a>XFRM Interface Management</h3>
<div class="paragraph">
<p>With <code><strong>iproute2</strong></code> 5.1.0 and newer an XFRM interface can be created as such:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip link add &lt;name&gt; type xfrm dev &lt;underlying interface&gt; if_id &lt;interface ID&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>strongSwan also comes with a utility (called <code><strong>xfrmi</strong></code>) to create XFRM interfaces
if <code><strong>iproute2</strong></code> can not create the interface.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/usr/local/libexec/ipsec/xfrmi --name &lt;name&gt; --id &lt;interface ID&gt; --dev &lt;underlying interface&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><code>&lt;name&gt;</code> can be any valid device name (e.g. <code><strong>ipsec0</strong></code>, <code><strong>xfrm0</strong></code>, etc.).
<code>&lt;interface ID&gt;</code> is a decimal or hex (<code><strong>0x</strong></code> prefix) 32-bit number. The underlying
interface currently is mandatory, but doesn&#8217;t really matter (it only does if an
interface is configured on the outbound policy - and it might with hardware IPsec
offloading, but that has not been tested by us), so it could be anything, even <code><strong>lo</strong></code>.</p>
</div>
<div class="paragraph">
<p>The interface can afterwards be managed via <code><strong>iproute2</strong></code>. So to activate it, use</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip link set &lt;name&gt; up</pre>
</div>
</div>
<div class="paragraph">
<p>Addresses, if necessary, can be added with <code><strong>ip addr</strong></code> and the interface may
eventually be deleted with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip link del &lt;name&gt;</pre>
</div>
</div>
<div class="sect3">
<h4 id="_example_create_xfrm_interface_ipsec0"><a class="anchor" href="#_example_create_xfrm_interface_ipsec0"></a>Example: Create XFRM Interface (ipsec0)</h4>
<div class="listingblock">
<div class="content">
<pre>ip link add ipsec0 type xfrm dev eth0 if_id 42
# or if not supported by iproute2 yet:
/usr/local/libexec/ipsec/xfrmi --name ipsec0 --id 42 --dev eth0

ip link set ipsec0 up
ip route add 10.1.0.0/16 dev ipsec0
ip route add 10.2.0.0/16 dev ipsec0</pre>
</div>
</div>
<div class="paragraph">
<p>Statistics are available via</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip -s link show [&lt;name&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>The <code><strong>xfrmi</strong></code> command provides a <code><strong>--list</strong></code> option to list existing XFRM interfaces
if using older versions of <code><strong>iproute2</strong></code> does not list the interface ID of XFRM
interfaces yet with <code><strong>ip -d link</strong></code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_2"><a class="anchor" href="#_configuration_2"></a>Configuration</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
By default, the daemon will not install any routes for CHILD_SAs with
           outbound interface ID, so it&#8217;s not necessary to disable the route
           installation globally. Since version 5.9.10 strongSwan optionally
           installs routes automatically (see below)
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Keep in mind that traffic routed to XFRM interfaces has to match the negotiated
IPsec policies. Therefore, connections are configured as they would if no interfaces
were to be used. However, since policies won&#8217;t affect traffic that&#8217;s not routed
via XFRM interfaces, it&#8217;s possible to negotiate <code><strong>0.0.0.0/0</strong></code> or <code><strong>::/0</strong></code> as traffic
selector on both ends to tunnel arbitrary traffic.</p>
</div>
<div class="paragraph">
<p>The most important connection configuration option in
<a href="../swanctl/swanctlConf.html" class="xref page"><code><strong>swanctl.conf</strong></code></a> is the interface ID <code><strong>if_id_in</strong></code>
and <code><strong>if_id_out</strong></code>. To use a single interface for in- and outbound traffic set them
to the same value (or <code><strong>%unique</strong></code> to generate a unique ID for each CHILD_SA).
To use separate interfaces for each direction, configure distinct values (or
<code><strong>%unique-dir</strong></code> to generate unique IDs for each CHILD_SA and direction). It&#8217;s also
possible to use an XFRM interface only in one direction by setting only one of the
two settings.</p>
</div>
<div class="paragraph">
<p>When setting the options on the connection-level, all CHILD_SAs for which the
settings are not set will inherit the interface IDs of the IKE_SA (use <code><strong>%unique</strong></code>
or <code><strong>%unique-dir</strong></code> to allocate unique IDs for each IKE_SA/direction that are
inherited by all CHILD_SAs created under the IKE_SA).</p>
</div>
<div class="paragraph">
<p>It&#8217;s possible to use transport mode for host-to-host connections between two peers.</p>
</div>
<div class="paragraph">
<p>Since version 5.9.10, strongSwan optionally installs routes via XFRM
interfaces if the <code><strong>charon.plugins.kernel-netlink.install_routes_xfrmi</strong></code> option
is enabled. A route is only installed if an interface with the ID configured
in <code><strong>if_id_out</strong></code> exists when the corresponding CHILD_SA is installed.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
If the traffic selectors include the IKE traffic to the peer, enabling
         <code><strong>install_routes_xfrmi</strong></code> requires special care (similarly, if manually
         installed routes conflict with the IKE traffic to the peer). Besides
         excluding all traffic to the peer via bypass policies and throw routes,
         the easiest way to only exclude IKE traffic is setting a mark on the
         IKE socket (via <code><strong>charon.plugins.socket-default.fwmark</strong>=&lt;mark&gt;</code>) and
         excluding such packets from the configured routing table where routes
         via XFRM interface are installed (via
         <code><strong>charon.plugins.kernel-netlink.fwmark</strong>=!&lt;mark&gt;</code>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_example_3"><a class="anchor" href="#_example_3"></a>Example</h3>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.strongswan.org/testing/testresults6/route-based/net2net-xfrmi"><img src="../_images/a-m-w-s-b.png" alt="topology" width="501" height="190"></a>
</div>
<div class="title">Figure 3. strongSwan <a href="https://www.strongswan.org/testing/testresults6/route-based/net2net-xfrmi">example</a> showing the use of XFRM interfaces</div>
</div>
</div>
<div class="sect2">
<h3 id="_sharing_xfrm_interfaces"><a class="anchor" href="#_sharing_xfrm_interfaces"></a>Sharing XFRM Interfaces</h3>
<div class="paragraph">
<p>Because no endpoint addresses are configured on the interfaces they can easily be
shared by multiple SAs as long as the policies don&#8217;t conflict. Just configure the
same interface ID for the CHILD_SAs (this also works automatically for roadwarrior
connections where each client gets an individual IP address assigned - just route
the subnets used for virtual IPs to the XFRM interface).</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_4"><a class="anchor" href="#_example_4"></a>Example</h3>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.strongswan.org/testing/testresults6/route-based/rw-shared-xfrmi"><img src="../_images/a-m-c-w-d.png" alt="topology" width="372" height="190"></a>
</div>
<div class="title">Figure 4. strongSwan <a href="https://www.strongswan.org/testing/testresults6/route-based/rw-shared-xfrmi">example</a> showing the use of shared XFRM interfaces</div>
</div>
</div>
<div class="sect2">
<h3 id="_connection_specific_xfrm_interfaces"><a class="anchor" href="#_connection_specific_xfrm_interfaces"></a>Connection-specific XFRM Interfaces</h3>
<div class="paragraph">
<p>Using custom <a href="../plugins/vici.html" class="xref page"><code><strong>vici</strong></code></a> or <a href="../plugins/updown.html" class="xref page"><code><strong>updown</strong></code></a>
scripts allows creating connection-specific XFRM interfaces. The interface ID
(in particular if <code><strong>%unique[-dir]</strong></code> is used) is available in the scripts to create
the XFRM interface dynamically.</p>
</div>
<div class="paragraph">
<p>Note that <a href="../plugins/updown.html" class="xref page"><code><strong>updown</strong></code></a> scripts are called for each
combination of of local and remote subnet, so this might cause conflicts if more
than one subnet is negotiated in the traffic selectors (i.e. this requires some
kind of refcounting). The <code><strong>child-updown</strong></code> <a href="../plugins/vici.html" class="xref page"><code><strong>vici</strong></code></a> event,
however is only triggered once per CHILD_SA. To create connection-level XFRM
interfaces with dynamic interface IDs, use the <code><strong>ike-updown</strong></code>
<a href="../plugins/vici.html" class="xref page"><code><strong>vici</strong></code></a> event.</p>
</div>
</div>
<div class="sect2">
<h3 id="_network_namespaces"><a class="anchor" href="#_network_namespaces"></a>Network Namespaces</h3>
<div class="paragraph">
<p>XFRM interfaces can be moved to network namespaces to provide the processes there
access to IPsec SAs/policies that were created in a different network namespace.
For instance, this allows a single IKE daemon to provide IPsec connections for
processes in different network namespaces (or full containers) without them having
access to the keys of the SAs (the SAs won&#8217;t be visible in the other network
namespaces, only the XFRM interface).</p>
</div>
</div>
<div class="sect2">
<h3 id="_xfrm_interfaces_in_vrfs"><a class="anchor" href="#_xfrm_interfaces_in_vrfs"></a>XFRM interfaces in VRFs</h3>
<div class="paragraph">
<p>XFRM interfaces can be associated to a VRF layer 3 master device, so any tunnel
terminated by an XFRM interface implicitly is bound to that VRF domain. For example,
this allows multi-tenancy setups where traffic from different tunnels can be
separated and routed over different interfaces.</p>
</div>
<div class="paragraph">
<p>Due to a limitation in XFRM interfaces, inbound traffic fails policy checking in
kernels prior to version 5.1.</p>
</div>
</div>
<div class="sect2">
<h3 id="_netfilter_ipsec_policy_match_with_xfrm_interfaces"><a class="anchor" href="#_netfilter_ipsec_policy_match_with_xfrm_interfaces"></a>Netfilter IPsec Policy Match with XFRM Interfaces</h3>
<div class="paragraph">
<p>Due to a limitation in the Netfilter IPsec <code><strong>policy</strong></code> match, output traffic
forwarded over an XFRM interface does not match (inbound it matches, though).
<code><strong>policy</strong></code> matching is not really required anymore when using XFRM interfaces, as
the Netfilter rules can just match on the interface. So the work-around is to
filter just on XFRM interface names instead of IPsec <code><strong>policy</strong></code> matches.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_marks_on_linux"><a class="anchor" href="#_marks_on_linux"></a>Marks on Linux</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the core features of VTI devices or XFRM interfaces, dynamically specifying
which traffic to tunnel can actually be replicated directly with marks and firewall
rules. By configuring connections with marks and then selectively marking packets
directly with Netfilter rules via <code><strong>MARK</strong></code> target in the <code><strong>PREROUTING</strong></code> or
<code><strong>FORWARD</strong></code> chains only specific traffic will get tunneled.</p>
</div>
<div class="paragraph">
<p>This may also be used to create multiple identical tunnels for which firewall rules
dynamically decide which traffic is tunneled through which IPsec SA.</p>
</div>
<div class="sect2">
<h3 id="_example_5"><a class="anchor" href="#_example_5"></a>Example</h3>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.strongswan.org/testing/testresults6/ikev2/net2net-psk-dscp"><img src="../_images/a-v-m-w-s-b.png" alt="topology" width="501" height="190"></a>
</div>
<div class="title">Figure 5. strongSwan <a href="https://www.strongswan.org/testing/testresults6/ikev2/net2net-psk-dscp">example</a> showing the use of marks for QoS/DiffServ</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_gre_tunnels"><a class="anchor" href="#_gre_tunnels"></a>GRE Tunnels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Another alternative is to use GRE (Generic Routing Encapsulation) which is a
generic point-to-point tunneling protocol that adds an additional encapsulation
layer (at least 4 bytes).  But it provides a portable way of creating route-based
VPNs (running a routing protocol on-top is also easy).</p>
</div>
<div class="paragraph">
<p>While VTI devices depend on site-to-site IPsec connections in tunnel mode (XFRM
interfaces are more flexible), GRE uses a host-to-host connection that can also be
run in transport mode (avoiding additional overhead). But while VTI devices and
XFRM interfaces may be used by only one of the peers, GRE must be used by both of
them.</p>
</div>
<div class="sect2">
<h3 id="_gre_tunnel_management"><a class="anchor" href="#_gre_tunnel_management"></a>GRE Tunnel Management</h3>
<div class="paragraph">
<p>Creating a GRE tunnel on Linux can be done as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip tunnel add &lt;name&gt; local &lt;local IP&gt; remote &lt;remote IP&gt; mode gre</pre>
</div>
</div>
<div class="paragraph">
<p><code>&lt;name&gt;</code> can be any valid interface name (e.g. <code><strong>ipsec0</strong></code>, <code><strong>gre0</strong></code>, etc.). But
note that the <code><strong>ip</strong></code> command treats names starting with <code><strong>gre</strong></code> special in some
instances (e.g. when retrieving device statistics). The IPs are the endpoints of
the IPsec tunnel.</p>
</div>
<div class="paragraph">
<p>After creating the interface it has to be enabled with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip link set &lt;name&gt; up</pre>
</div>
</div>
<div class="paragraph">
<p>and then routes may be installed.</p>
</div>
<div class="sect3">
<h4 id="_example_creation_of_gre_tunnel_ipsec0"><a class="anchor" href="#_example_creation_of_gre_tunnel_ipsec0"></a>Example: Creation of GRE Tunnel (ipsec0)</h4>
<div class="listingblock">
<div class="content">
<pre>ip tunnel add ipsec0 local 192.168.0.1 remote 192.168.0.2 mode gre
ip link set ipsec0 up
ip route add 10.1.0.0/16 dev ipsec0
ip route add 10.2.0.0/16 dev ipsec0</pre>
</div>
</div>
<div class="paragraph">
<p>Statistics on GRE devices may be displayed with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip -s tunnel show [&lt;name&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>Note that specifying a name will not show any statistics if the device name starts
with <code><strong>gre</strong></code>.</p>
</div>
<div class="paragraph">
<p>A GRE device may be removed again with</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ip tunnel del &lt;name&gt;</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_3"><a class="anchor" href="#_configuration_3"></a>Configuration</h3>
<div class="paragraph">
<p>As mentioned above, a host-to-host IPsec connection in transport mode can be used.
The traffic selectors may even be limited to just the GRE protocol
(<code><strong>local_ts|remote_ts = dynamic[gre]</strong></code> in
<a href="../swanctl/swanctlConf.html" class="xref page"><code><strong>swanctl.conf</strong></code></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_example_6"><a class="anchor" href="#_example_6"></a>Example</h3>
<div class="imageblock">
<div class="content">
<a class="image" href="https://www.strongswan.org/testing/testresults6/route-based/net2net-gre"><img src="../_images/a-m-w-s-b.png" alt="topology" width="501" height="190"></a>
</div>
<div class="title">Figure 6. strongSwan <a href="https://www.strongswan.org/testing/testresults6/route-based/net2net-gre">example</a> showing the use of GRE tunnels</div>
</div>
</div>
<div class="sect2">
<h3 id="_automation"><a class="anchor" href="#_automation"></a>Automation</h3>
<div class="paragraph">
<p>Setting up and configuration of GRE tunnels can be automated using <code><strong>systemd</strong></code>
units (templates) and a custom updown script to set the correct IP address for
remote peers using GRE tunnels.</p>
</div>
<div class="paragraph">
<p>The following files outline fully functional examples for implementing that:</p>
</div>
<div class="sect3">
<h4 id="_systemd_unit"><a class="anchor" href="#_systemd_unit"></a>systemd Unit</h4>
<div class="listingblock">
<div class="content">
<pre>[Unit]
Description=GRE Tunnel service

[Service]
Type=oneshot
RemainAfterExit=yes
Environment=UNBOUND="127.0.0.2"
EnvironmentFile=/etc/conf.d/gre-%i.conf
ExecStart=sh -c '/sbin/ip link add name "$TUNNEL_NAME" type gre key "$KEY" ttl 64 remote "$UNBOUND" dev "$DEVICE"'
ExecStart=/sbin/ip link set mtu 1350 dev "$TUNNEL_NAME"
ExecStart=/sbin/ip link set multicast on dev "$TUNNEL_NAME"
ExecStart=/sbin/ip link set up dev "$TUNNEL_NAME"
# ExecStart=/sbin/ip addr add "${LOCALSRCIP}/30" dev "$TUNNEL_NAME"
ExecStart=/sbin/ip addr add "${LOCALSRCIP}/32" dev "$TUNNEL_NAME"
ExecStop=/sbin/ip link delete dev "$TUNNEL_NAME"
ExecStopPost=/sbin/ip link delete dev "$TUNNEL_NAME"

[Install]
WantedBy=network.target</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_updown_script"><a class="anchor" href="#_updown_script"></a>updown Script</h4>
<div class="listingblock">
<div class="content">
<pre>#!/bin/bash

PROG="$(basename $0)"

_ip()
{
  logger -i -t "$PROG" ip "$@"
  ip "$@"
}

logger -i -t "$PROG" "$0 $@"

case "$PLUTO_VERB" in

up-host)
  TUNNEL_NAME="$PLUTO_CONNECTION"
  LOCAL="$PLUTO_ME"
  REMOTE="$PLUTO_PEER"

  _ip link set "$TUNNEL_NAME" type gre local "$LOCAL" remote "$REMOTE"

  # disable martian filtering on unnumbered links; Required for doing OSPF over unnumbered links.
  sysctl -q -w "net.ipv4.conf.$TUNNEL_NAME.rp_filter=0"
  ;;

down-host)
	;;

esac

exit 0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gre_config_file"><a class="anchor" href="#_gre_config_file"></a>gre config File</h4>
<div class="paragraph">
<p>config file under <code><strong>/etc/conf.d/</strong></code>, matches the glob <code><strong>/etc/conf.d/gre-&ast;.conf</strong></code></p>
</div>
<div class="listingblock">
<div class="content">
<pre>TUNNEL_NAME="tun-EXAMPLE"
DEVICE="eth0"
# this is the gre key; It should be unique per GRE tunnel; Maybe generate it by sha256'ing the ip addresses of the peers involved.
KEY="0xRANDOMNUMBERGOESHERE"
# local IP address of GRE tunnel; It will be the source IP of the GRE packets sent by the host to the remote IP
LOCAL=IP_ADDRESS_OF_eth0_GOES_HERE
# remote peer's IP address of the GRE tunnel
REMOTE=IP_ADDRESS_OF_OTHER_HOST_GOES_HERE
LOCALSRCIP="$localsrcip"</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_libipsec_and_tun_devices"><a class="anchor" href="#_libipsec_and_tun_devices"></a>libipsec and TUN Devices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Based on our own userland IPsec implementation and the
<a href="../plugins/kernel-libipsec.html" class="xref page"><code><strong>kernel-libipsec</strong></code></a> plugin it is possible to
create route-based VPNs with TUN devices. Similar to VTI devices or XFRM interfaces
the negotiated IPsec policies have to match the traffic routed via TUN device.
In particular because packets have to be copied between kernel and userland it is
not as efficient as the solutions above (also read the notes on
<a href="../plugins/kernel-libipsec.html" class="xref page"><code><strong>kernel-libipsec</strong></code></a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problems"><a class="anchor" href="#_problems"></a>Problems</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure to disable the <a href="../plugins/connmark.html" class="xref page"><code><strong>connmark</strong></code></a> plugin when running
a VTI interface. Otherwise, it will insert Netfilter rules into the <code><strong>mangle</strong></code> table
that prevent the VTI from working.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="networkManager.html">NetworkManager</a></span>
  <span class="next"><a href="highAvailability.html">High Availability</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a href="https://www.strongswan.org/"> 
     <img src="../../../_/img/strongswan.png" alt="strongSwan Logo" height="100"
        width="153" style="vertical-align:middle;float:left;margin:0px 20px"></a>
  <p>Copyright &copy; 2021-2023
     <a href="mailto:info@.strongswan.org">The strongSwan Team</a> and individual contributors.
     The <a href="https://github.com/strongswan/strongswan-docs">content</a>
     is provided under a <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> license<p>
  <p>The <a href="https://github.com/strongswan/strongswan-antora">UI</a>
     for this site is derived from the Antora default UI and is licensed under
     the <a href="https://www.mozilla.org/en-US/MPL/2.0/">MPL-2.0</a> license.</p>
 </footer>

<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
